{% extends "base.html" %}
{% block content %}

<div class="container py-5">

    <a href="{{ url_for('jobs.posts') }}" class="btn btn-outline-secondary mb-4">
        <i class="bi bi-arrow-left me-1"></i> Back to Jobs
    </a>

    <div class="card shadow-sm border-0 p-4 job-details-card">

        <div class="d-flex justify-content-between">
            <div>
                <h2 class="fw-bold mb-1">{{ job.title }}</h2>
                <p class="text-muted mb-2">
                    <i class="bi bi-building me-1"></i> {{ job.company }}
                </p>
            </div>
        </div>

        <hr class="my-4">

        <div class="d-flex align-items-center mb-4">
            <div class="me-3">
                <i class="bi bi-person-circle text-primary" style="font-size: 2.2rem;"></i>
            </div>

            <div>
                <div class="fw-semibold text-capitalize">
                    Posted by {{ job.user.first_name }} {{ job.user.last_name }}
                </div>

                <a href="{{ url_for('auth.view_profile', user_id=job.user.id) }}"
                    class="fw-semibold text-decoration-none text-dark"
                    style="text-decoration: underline; cursor: pointer;">
                    {{ job.user.email }}
                </a>

                <div>
                    <span class="badge bg-secondary mt-1">
                        {{ job.user.role.upper() }}
                    </span>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <div class="row mb-4">
            {% if job.experience_required %}
            <div class="col-md-6 mb-3">
                <span class="badge bg-primary-subtle text-primary px-3 py-2">
                    <i class="bi bi-briefcase-fill me-1"></i>
                    Experience Required: {{ job.experience_required }}
                </span>
            </div>
            {% endif %}

            {% if job.degree_required %}
            <div class="col-md-6 mb-3">
                <span class="badge bg-success-subtle text-success px-3 py-2">
                    <i class="bi bi-mortarboard-fill me-1"></i>
                    Degree Required: {{ job.degree_required }}
                </span>
            </div>
            {% endif %}
        </div>

        <h5 class="fw-semibold">Job Description</h5>
        <p class="text-secondary fs-6" style="line-height: 1.7;">
            {{ job.description }}
        </p>

        <hr class="my-4">

        <div class="d-flex flex-wrap gap-3">
            {% if job.created_at %}
            <span class="text-muted small">
                <i class="bi bi-clock me-1"></i>
                Posted on {{ job.created_at.strftime('%B %d, %Y') }}
            </span>
            {% endif %}
        </div>

        <hr class="my-5">

        <h4 class="fw-bold mb-3">Applicants</h4>

        {% if job.applications|length == 0 %}
            <p class="text-muted">No applicants yet.</p>
        {% else %}
            <div class="list-group">

                {% for application in job.applications %}
                <div class="list-group-item py-3">

                    <div class="d-flex justify-content-between align-items-center">

                        <div>
                            <h6 class="fw-semibold mb-1">
                                <a href="{{ url_for('auth.view_profile', user_id=application.user.id) }}"
                                    class="text-decoration-none">
                                    {{ application.user.first_name }} {{ application.user.last_name }}
                                </a>
                            </h6>

                            <p class="text-muted small mb-1">
                                {{ application.user.email }}
                            </p>

                            {% if application.resume_file %}

                                {% set can_view_resume =
                                    (current_user.role == 'admin') or
                                    (current_user.id == job.user_id) or
                                    (current_user.id == application.user_id)
                                %}

                                {% if can_view_resume %}
                                    <a href="{{ url_for('jobs.view_resume', application_id=application.id) }}"
                                        class="btn btn-sm btn-outline-primary"
                                        target="_blank">
                                        <i class="bi bi-file-earmark-pdf me-1"></i> View Resume
                                    </a>
                                {% else %}
                                    <span class="text-muted small">
                                        ðŸ”’ Resume hidden
                                    </span>
                                {% endif %}

                            {% endif %}
                        </div>

                        {% if current_user.role in ["admin", "employer"] %}
                        <a href="{{ url_for('jobs.hire_applicant', application_id=application.id) }}"
                            class="btn btn-success">
                            Hire
                        </a>
                        {% endif %}

                    </div>

                </div>
                {% endfor %}

            </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.id == job.user_id %}
        <div class="mt-4 pt-3 d-flex gap-2">
            
            {# ---- Check if edit_post exists ---- #}
            {% if 'jobs.edit_post' in current_app.view_functions %}
                <a href="{{ url_for('jobs.edit_post', job_id=job.id) }}"
                    class="btn btn-primary px-4">
                    <i class="bi bi-pencil-square me-1"></i> Edit
                </a>
            {% endif %}

            {# ---- Check if delete_post exists ---- #}
            {% if 'jobs.delete_post' in current_app.view_functions %}
                <form method="POST" action="{{ url_for('jobs.delete_post', job_id=job.id) }}" 
                      style="display: inline;">
                    <button type="submit" 
                            class="btn btn-danger px-4"
                            onclick="return confirm('Are you sure you want to delete this job post? This action cannot be undone.');">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </form>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
.job-details-card {
    border-radius: 16px;
}
</style>

{% endblock %}